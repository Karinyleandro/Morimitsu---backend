generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                    Int                  @id @default(autoincrement())
  tipo_usuario          TipoUsuario
  cargo_aluno           CargoAluno?
  nome                  String
  nome_social           String?
  num_matricula         Int?                 @unique
  cpf                   String               @unique
  dataNascimento        DateTime
  telefone              String?
  endereco              String?
  grau                  Int?
  email                 String               @unique
  genero                Genero
  imagem_perfil_url     String?
  ativo                 Boolean              @default(true)
  ultimo_login          DateTime?
  criado_em             DateTime             @default(now())
  atualizado_em         DateTime             @default(now())
  id_faixa              Int?
  passwordHash          String?
  aluno_turmas          Aluno_Turma[]
  registradas           Frequencia[]         @relation("RegistradorFrequencias")
  frequencias           Frequencia[]         @relation("AlunoFrequencias")
  graduacoesCoordenador Graduacao[]          @relation("CoordenadorGraduacoes")
  graduacoes            Graduacao[]          @relation("UsuarioGraduacoes")
  log_acoes             Log_Acao[]
  passwordResetTokens   PasswordResetToken[]
  responsaveis          Responsavel[]
  turmasComoCoordenador Turma[]              @relation("CoordenadorTurmas")
  turmasComoProfessor   Turma[]              @relation("ProfessorTurmas")
  faixa                 Faixa?                @relation(fields: [id_faixa], references: [id])
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  used      Boolean  @default(false)
  user      Usuario  @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RevokedToken {
  id        Int      @id @default(autoincrement())
  jti       String   @unique
  expiresAt DateTime
}

model Responsavel {
  id              Int     @id @default(autoincrement())
  nome            String
  telefone        String
  grau_parentesco String
  email           String
  id_usuario      Int
  usuario         Usuario @relation(fields: [id_usuario], references: [id], onDelete: Cascade)
}

model Faixa {
  id               Int              @id @default(autoincrement())
  nome             String
  ordem            Int
  imagem_faixa_url String?
  graduacoes       Graduacao[]
  requisitos       Requisito_Grau[]
  usuarios         Usuario[]
}

model Requisito_Grau {
  id                Int     @id @default(autoincrement())
  faixa_id          Int
  grau              Int
  requisito_aulas   Int
  tempo_minimo_dias Int
  descricao         String?
  faixa             Faixa   @relation(fields: [faixa_id], references: [id], onDelete: Cascade)
}

model Turma {
  id               Int           @id @default(autoincrement())
  nome_turma       String
  data_criacao     DateTime      @default(now())
  faixa_etaria_min Int
  faixa_etaria_max Int
  total_aulas      Int
  id_professor     Int?
  id_coordenador   Int?
  ativo            Boolean       @default(true)
  aluno_turmas     Aluno_Turma[]
  frequencias      Frequencia[]
  coordenador      Usuario?      @relation("CoordenadorTurmas", fields: [id_coordenador], references: [id])
  professor        Usuario?      @relation("ProfessorTurmas", fields: [id_professor], references: [id])
}

model Aluno_Turma {
  id_usuario           Int
  id_turma             Int
  frequencia_acumulada Float?  @default(0)
  ativo                Boolean @default(true)
  turma                Turma   @relation(fields: [id_turma], references: [id], onDelete: Cascade)
  usuario              Usuario @relation(fields: [id_usuario], references: [id])
  @@id([id_usuario, id_turma])
}

model Frequencia {
  id             Int      @id @default(autoincrement())
  id_turma       Int
  id_usuario     Int
  id_registrador Int
  data_aula      DateTime
  presente       Boolean
  criado_em      DateTime @default(now())
  registrador    Usuario  @relation("RegistradorFrequencias", fields: [id_registrador], references: [id])
  turma          Turma    @relation(fields: [id_turma], references: [id], onDelete: Cascade)
  usuario        Usuario  @relation("AlunoFrequencias", fields: [id_usuario], references: [id], onDelete: Cascade)
}

model Graduacao {
  id             Int      @id @default(autoincrement())
  id_usuario     Int
  id_coordenador Int
  faixa_id       Int
  grau           Int
  data_graduacao DateTime
  observacao     String?
  faixa          Faixa    @relation(fields: [faixa_id], references: [id])
  coordenador    Usuario  @relation("CoordenadorGraduacoes", fields: [id_coordenador], references: [id])
  usuario        Usuario  @relation("UsuarioGraduacoes", fields: [id_usuario], references: [id], onDelete: Cascade)
}

model Log_Acao {
  id            Int      @id @default(autoincrement())
  usuario_id    Int?
  acao          String
  descricao     String?
  data_execucao DateTime @default(now())
  usuario       Usuario? @relation(fields: [usuario_id], references: [id])
}

enum Genero {
  M
  F
  OUTRO
}

enum TipoUsuario {
  PROFESSOR
  COORDENADOR
  ALUNO
}

enum CargoAluno {
  ALUNO
  ALUNO_PROFESSOR
}
