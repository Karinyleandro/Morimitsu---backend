generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Genero {
  M
  F
  OUTRO
}

enum TipoUsuario {
  ADMIN
  PROFESSOR
  COORDENADOR
  ALUNO
  ALUNO_PROFESSOR
}

model Usuario {
  id                String   @id @default(uuid())

  nome              String
  nome_social       String?
  cpf               String? @unique
  dataNascimento    DateTime?
  telefone          String?
  endereco          String?
  genero            Genero?
  imagem_perfil_url String?

  email             String? @unique
  passwordHash      String?

  tipo              TipoUsuario
  ativo             Boolean @default(true)
  ultimo_login      DateTime?

  // Faixa + grau (para qualquer usuario)
  id_faixa          String?
  grau              Int?

  // Apenas aluno ou aluno-professor
  num_matricula     String? @unique

  criado_em         DateTime @default(now())
  atualizado_em     DateTime @default(now()) @updatedAt

  // RELACIONAMENTOS
  faixa             Faixa? @relation("FaixaUsuarios", fields: [id_faixa], references: [id])
  graduacoes        Graduacao[]
  responsaveis      Responsavel[]
  turma_matriculas  Aluno_Turma[]
  frequencias       Frequencia[] @relation("UsuarioFrequencias")

  turmasComoCoordenador Turma[] @relation("CoordenadorTurmas")
  turmasComoProfessor   Turma[] @relation("ProfessorTurmas")
  registradas           Frequencia[] @relation("RegistradorFrequencias")

  logs                  Log_Acao[]
  resetTokens           PasswordResetToken[]
  turmas_responsavel    TurmaResponsavel[]
}

model Responsavel {
  id              String @id @default(uuid())
  nome            String
  telefone        String
  grau_parentesco String
  email           String?
  alunoId         String

  aluno           Usuario @relation(fields: [alunoId], references: [id], onDelete: Cascade)
}

model Faixa {
  id               String   @id @default(uuid())
  nome             String
  ordem            Int @unique
  imagem_faixa_url String?

  requisitos       Requisito_Grau[]
  graduacoes       Graduacao[]

  // Relacionamento correto com Usuario
  alunos           Usuario[] @relation("FaixaUsuarios")
}

model Requisito_Grau {
  id                String @id @default(uuid())
  faixa_id          String
  grau              Int
  requisito_aulas   Int
  tempo_minimo_dias Int
  descricao         String?

  faixa             Faixa @relation(fields: [faixa_id], references: [id], onDelete: Cascade)
}

model Turma {
  id                  String   @id @default(uuid())
  nome_turma          String
  data_criacao        DateTime? @default(now())
  faixa_etaria_min    Int
  faixa_etaria_max    Int
  total_aulas         Int?

  id_professor        String?
  id_coordenador      String?
  ativo               Boolean? @default(true)

  imagem_turma_url    String?

  aluno_turmas        Aluno_Turma[]
  frequencias         Frequencia[]
  responsaveis        TurmaResponsavel[]

  coordenador         Usuario? @relation("CoordenadorTurmas", fields: [id_coordenador], references: [id])
  professor           Usuario? @relation("ProfessorTurmas", fields: [id_professor], references: [id])
}

model TurmaResponsavel {
  id        String @id @default(uuid())
  turmaId   String
  usuarioId String
  criado_em DateTime @default(now())

  turma     Turma   @relation(fields: [turmaId], references: [id], onDelete: Cascade)
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  @@unique([turmaId, usuarioId])
}

model Aluno_Turma {
  id_aluno             String
  id_turma             String
  frequencia_acumulada Float? @default(0)
  ativo                Boolean @default(true)

  aluno                Usuario @relation(fields: [id_aluno], references: [id])
  turma                Turma   @relation(fields: [id_turma], references: [id], onDelete: Cascade)

  @@id([id_aluno, id_turma])
}

model Frequencia {
  id             String   @id @default(uuid())
  id_turma       String
  id_aluno       String
  id_registrador String
  data_aula      DateTime
  presente       Boolean
  criado_em      DateTime @default(now())

  registrador    Usuario @relation("RegistradorFrequencias", fields: [id_registrador], references: [id])
  turma          Turma   @relation(fields: [id_turma], references: [id], onDelete: Cascade)
  aluno          Usuario @relation("UsuarioFrequencias", fields: [id_aluno], references: [id], onDelete: Cascade)
}

model Graduacao {
  id             String   @id @default(uuid())
  alunoId        String
  faixa_id       String
  grau           Int
  data_graduacao DateTime
  observacao     String?

  aluno          Usuario @relation(fields: [alunoId], references: [id], onDelete: Cascade)
  faixa          Faixa   @relation(fields: [faixa_id], references: [id])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  user      Usuario  @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RevokedToken {
  id        String   @id @default(uuid())
  jti       String   @unique
  expiresAt DateTime
}

model Log_Acao {
  id            String   @id @default(uuid())
  usuario_id    String?
  acao          String
  descricao     String?
  data_execucao DateTime @default(now())

  usuario       Usuario? @relation(fields: [usuario_id], references: [id])
}